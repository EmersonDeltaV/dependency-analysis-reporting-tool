using Newtonsoft.Json.Linq;

namespace DART.BlackduckAnalysis.Helpers
{
    public static class VulnerabilityReportParser
    {
        public static string? ExtractReportId(JToken? reportToken)
        {
            if (reportToken is null)
            {
                return null;
            }

            var directId = reportToken["id"]?.ToString();
            if (!string.IsNullOrWhiteSpace(directId))
            {
                return directId;
            }

            var metaToken = reportToken["_meta"];
            if (metaToken != null)
            {
                var hrefId = ExtractIdFromUri(metaToken["href"]?.ToString());
                if (!string.IsNullOrEmpty(hrefId))
                {
                    return hrefId;
                }

                if (metaToken["links"] is JArray links)
                {
                    foreach (var link in links.OfType<JToken>())
                    {
                        var candidate = ExtractIdFromUri(link?["href"]?.ToString());
                        if (!string.IsNullOrEmpty(candidate))
                        {
                            return candidate;
                        }
                    }
                }
            }

            return null;
        }

        public static bool IsReportComplete(JToken? reportToken)
        {
            if (reportToken is null)
            {
                return false;
            }

            var completeValue = reportToken["complete"]?.ToString();
            if (!string.IsNullOrWhiteSpace(completeValue) && bool.TryParse(completeValue, out var complete))
            {
                return complete;
            }

            var status = reportToken["status"]?.ToString();
            return string.Equals(status, "COMPLETED", StringComparison.OrdinalIgnoreCase);
        }

        private static string? ExtractIdFromUri(string? uriOrPath)
        {
            if (string.IsNullOrWhiteSpace(uriOrPath))
            {
                return null;
            }

            if (Uri.TryCreate(uriOrPath, UriKind.Absolute, out var absoluteUri))
            {
                return GetLastSegment(absoluteUri.AbsolutePath);
            }

            if (Uri.TryCreate(uriOrPath, UriKind.Relative, out var relativeUri))
            {
                return GetLastSegment(relativeUri.OriginalString);
            }

            return GetLastSegment(uriOrPath);
        }

        private static string? GetLastSegment(string? path)
        {
            if (string.IsNullOrWhiteSpace(path))
            {
                return null;
            }

            var trimmed = path.TrimEnd('/');
            var lastSlash = trimmed.LastIndexOf('/');
            return lastSlash >= 0 ? trimmed[(lastSlash + 1)..] : trimmed;
        }
    }
}
